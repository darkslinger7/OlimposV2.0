<%- include('../partials/header') %>
<%- include('../partials/sidebar_super') %>
<%- include('../partials/navbar', { titulo: 'Gestión de Personal', icono: 'fa-id-badge', usuario }) %>

<style>
    /* Estilos del Modal */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 2000; 
        left: 0; top: 0; 
        width: 100%; height: 100%; 
        background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
    }
    .modal-content {
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        width: 90%; max-width: 500px;
        position: relative;
        animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .close-modal {
        position: absolute; right: 20px; top: 15px;
        font-size: 24px; cursor: pointer; color: #aaa;
    }
    .close-modal:hover { color: #000; }
    
    /* Grid para separar Personal de Configuración */
    .trabajadores-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    @media (max-width: 900px) {
        .trabajadores-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="main-content">
  <main class="content">

    <div class="trabajadores-grid">
        
        <section>
            <div class="tarjetas-panel" style="margin-bottom: 1.5rem; grid-template-columns: 1fr;">
                <div class="tarjeta">
                    <div class="icono-tarjeta fondo-naranja">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="info-tarjeta">
                        <h3>Personal Activo</h3>
                        <p><%= trabajadores.length %></p>
                    </div>
                </div>
            </div>

            <div class="crud">
                <h3 style="color: #e67e22; border-bottom: 2px solid #e67e22;"><i class="fas fa-user-tie"></i> Nómina de Empleados</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Cédula</th>
                            <th>Cargo Actual</th>
                            <th>Sueldo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (trabajadores.length > 0) { %>
                            <% trabajadores.forEach(u => { %>
                                <tr>
                                    <td>
                                        <strong><%= u.nombre_apellido %></strong><br>
                                        <small style="color: #7f8c8d;"><%= u.telefono %></small>
                                    </td>
                                    <td><%= u.cedula %></td>
                                    <td>
                                        <% if(u.nombre_trabajo) { %>
                                            <span class="badge" style="background: #34495e;"><%= u.nombre_trabajo %></span>
                                        <% } else { %>
                                            <span class="badge" style="background: #95a5a6;">Sin asignar</span>
                                        <% } %>
                                    </td>
                                    <td style="color: #27ae60; font-weight: bold;">
                                        <%= u.sueldo > 0 ? '$' + u.sueldo : '-' %>
                                    </td>
                                    <td>
                                        <button class="btn-sm" style="background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;"
                                                onclick="abrirModalAsignar('<%= u.id %>', '<%= u.nombre_apellido %>')">
                                            <i class="fas fa-edit"></i> Asignar
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="5" style="text-align: center;">No hay trabajadores registrados.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="agg" style="margin-bottom: 1.5rem;">
                <form method="POST" action="/super/trabajadores/registrarTrabajo" class="login-form" style="border-top-color: #8e44ad;">
                    <h4 style="grid-column: 1/-1; color: #8e44ad; margin-bottom: 10px;">Crear Nuevo Puesto</h4>
                    <div class="form-group">
                        <input name="nombre" placeholder="Nombre (Ej. Jardinero)" required>
                    </div>
                    <div class="form-group">
                        <input name="descripcion" placeholder="Descripción breve...">
                    </div>
                    <button type="submit" style="background: #8e44ad;">Guardar Puesto</button>
                </form>
            </div>

            <div class="crud" style="border-top-color: #8e44ad;">
                <h4 style="margin-bottom: 15px; color: #8e44ad;">Puestos Disponibles</h4>
                <ul style="list-style: none; padding: 0;">
                    <% if (trabajos.length > 0) { %>
                        <% trabajos.forEach(t => { %>
                            <li style="background: #f8f9fa; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-radius: 4px;">
                                <div>
                                    <strong><%= t.nombre %></strong>
                                    <p style="font-size: 0.8rem; color: #7f8c8d; margin: 0;"><%= t.descripcion %></p>
                                </div>
                                <a href="#" onclick="eliminarTrabajo('<%= t.id_trabajo %>')" style="color: #e74c3c;">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li style="color: #aaa; text-align: center;">No hay puestos creados.</li>
                    <% } %>
                </ul>
            </div>
        </section>

    </div>
  </main>

  <div id="modalAsignar" class="modal">
      <div class="modal-content">
          <span class="close-modal" onclick="cerrarModal()">&times;</span>
          <h3 style="color: #e67e22; margin-bottom: 20px;"><i class="fas fa-briefcase"></i> Asignar Cargo</h3>
          
          <p id="modalNombreUsuario" style="margin-bottom: 15px; font-weight: bold; font-size: 1.1rem;"></p>

          <form method="POST" action="/super/trabajadores/asignar">
              <input type="hidden" name="id_usuario" id="inputUserId">
              
              <div class="form-group" style="margin-bottom: 15px;">
                  <label>Seleccionar Puesto:</label>
                  <select name="id_trabajo" required style="width: 100%; padding: 8px;">
                      <option value="" disabled selected>-- Seleccione --</option>
                      <% trabajos.forEach(t => { %>
                          <option value="<%= t.id_trabajo %>"><%= t.nombre %></option>
                      <% }) %>
                  </select>
              </div>

              <div class="form-group" style="margin-bottom: 20px;">
                  <label>Sueldo Mensual ($):</label>
                  <input type="number" name="sueldo" step="0.01" min="0" placeholder="0.00" required style="width: 100%; padding: 8px;">
              </div>

              <button type="submit" style="width: 100%; background: #e67e22; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                  Guardar Asignación
              </button>
          </form>
      </div>
  </div>

<%- include('../partials/footer') %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Lógica del Modal
    const modal = document.getElementById('modalAsignar');

    function abrirModalAsignar(id, nombre) {
        document.getElementById('inputUserId').value = id;
        document.getElementById('modalNombreUsuario').innerText = "Empleado: " + nombre;
        modal.style.display = 'flex';
    }

    function cerrarModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(e) {
        if (e.target == modal) cerrarModal();
    }

    // Lógica Eliminar Puesto
    function eliminarTrabajo(id) {
        Swal.fire({
            title: '¿Eliminar puesto?',
            text: "Los empleados con este puesto quedarán 'Sin asignar'.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/super/trabajadores/eliminarTrabajo/' + id)
                    .then(res => {
                        if(res.ok) location.reload();
                        else Swal.fire('Error', 'No se pudo eliminar', 'error');
                    });
            }
        })
    }
</script>